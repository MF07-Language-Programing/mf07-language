name: Publish Installers to GitHub Pages

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:
  release:
    types: [published]

# Ensure the workflow has permission to push to `gh-pages` using the generated GITHUB_TOKEN
permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      # Put secrets in envs so we can reference them without using 'secrets' in 'if' expressions
      PAGES_PAT: ${{ secrets.PAGES_PAT }}
      PAGES_GPG_PRIVATE_KEY: ${{ secrets.PAGES_GPG_PRIVATE_KEY }}
      DEPLOY_TOKEN: ${{ secrets.PAGES_PAT || secrets.GITHUB_TOKEN }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Node (needed by deploy action)
        uses: actions/setup-node@v4
        with:
          node-version: '20'


      - name: Prepare public site
        run: |
          DEPLOY_DIR="public-deploy"
          mkdir -p "$DEPLOY_DIR"
          # Copy either build_tools/packaging/public artifacts to publish dir
          if [ -d "build_tools/packaging/public" ]; then
            cp -r build_tools/packaging/public/* "$DEPLOY_DIR/" 2>/dev/null || true
          fi
          # Copy top-level public assets if present in repo root
          if [ -d "public" ]; then
            cp -r public/* "$DEPLOY_DIR/" 2>/dev/null || true
          fi
          # Ensure dotfile exists for the deploy dir
          touch "$DEPLOY_DIR/.nojekyll" || true

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          # Use token from env to avoid secret context in if expressions
          github_token: ${{ env.DEPLOY_TOKEN }}
          publish_dir: ./public-deploy
          # configure to force push so updates are visible
          publish_branch: gh-pages
          keep_files: false
        continue-on-error: true

      - name: Check for PAT but missing GPG key (skip fallback when signing key not provided)
        if: ${{ env.PAGES_PAT != '' && env.PAGES_GPG_PRIVATE_KEY == '' }}
        run: |
          echo "PAGES_PAT is set but PAGES_GPG_PRIVATE_KEY is not. Skipping manual signed deploy fallback because branch requires signed commits."

      - name: Manual signed deploy (fallback for signed commits and creation protected branches)
        if: ${{ env.PAGES_PAT != '' && env.PAGES_GPG_PRIVATE_KEY != '' }}
        env:
          REPO: ${{ github.repository }}
          PAGES_PAT: ${{ env.PAGES_PAT }}
          SIGNING_NAME: ${{ secrets.PAGES_SIGNING_NAME }}
          SIGNING_EMAIL: ${{ secrets.PAGES_SIGNING_EMAIL }}
          GPG_PRIVATE_KEY: ${{ env.PAGES_GPG_PRIVATE_KEY }}
          GPG_PASSPHRASE: ${{ secrets.PAGES_GPG_PASSPHRASE }}
        run: |
          set -eux
          # If a GPG key is provided, import it for signing
          KEY_ID=""
          if [ -n "${GPG_PRIVATE_KEY:-}" ]; then
            sudo apt-get update
            sudo apt-get install -y --no-install-recommends gnupg2 pinentry-curses
            echo "$GPG_PRIVATE_KEY" | base64 --decode > /tmp/gpg.key
            export GNUPGHOME=$(mktemp -d)
            chmod 700 "$GNUPGHOME"
            gpg --batch --import /tmp/gpg.key
            # Extract key ID, format LONG
            KEY_ID=$(gpg --list-secret-keys --keyid-format LONG | awk '/sec/{print $2}' | sed 's#.*/##' | head -n1 || true)
            echo "GPG KEY ID: $KEY_ID"
            if [ -n "${GPG_PASSPHRASE:-}" ]; then
              gpgconf --reload gpg-agent || true
              echo 'allow-loopback-pinentry' | gpgconf --change-options gpg-agent || true
            fi
          fi
          DEPLOY_DIR=public-deploy
          TMP_REPO_DIR=$(mktemp -d)
          cd "$TMP_REPO_DIR"
          git init
          git checkout -b gh-pages || true
          cp -R "$GITHUB_WORKSPACE/$DEPLOY_DIR/"* . || true
          git config user.name "${SIGNING_NAME:-gh-pages-bot}"
          git config user.email "${SIGNING_EMAIL:-noreply@github.com}"
          if [ -n "$KEY_ID" ]; then
            git config user.signingkey "$KEY_ID"
            git config commit.gpgsign true
          fi
          git add -A
          if git diff --staged --quiet; then
            echo "No changes to publish"; exit 0
          fi
          if [ -n "$KEY_ID" ]; then
            export GPG_TTY=$(tty)
            echo "Committing with signing key $KEY_ID"
            git commit -S -m "Publish installers from ${GITHUB_REF} (${GITHUB_SHA})"
          else
            echo "Committing without signing key"
            git commit -m "Publish installers from ${GITHUB_REF} (${GITHUB_SHA})"
          fi
          echo "Commit signature details:"
          git show --show-signature --pretty=full -1 || true
          git log -1 --format='%H %G? %GK' || true
          git remote add origin "https://x-access-token:${PAGES_PAT}@github.com/${REPO}.git"
          echo "Pushing to origin gh-pages..."
          if ! git push origin gh-pages --force; then
            echo "git push failed. Show remote origin info:"; git remote -v || true
            echo "Try to describe remote refs:"; git ls-remote origin || true
            echo "Show last commit and signature again:"; git show --show-signature --pretty=full -1 || true
            exit 1
          fi