name: Release & Publish

on:
  push:
    branches:
      - main
    paths:
      - 'pyproject.toml'
  pull_request:
    branches:
      - main

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  detect-version:
    name: Detect Version Change
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      version-changed: ${{ steps.version.outputs.changed }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version from pyproject.toml
        id: version
        run: |
          VERSION=$(grep '^version' pyproject.toml | head -1 | sed 's/version = "\([^"]*\)".*/\1/')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          
          if git describe --tags --exact-match "v$VERSION" 2>/dev/null; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi
          
          echo "Current version: $VERSION"

  test:
    name: Run Tests
    needs: detect-version
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          python -m pip install --extra-index-url https://pypi.org/simple -e ".[dev]"

      - name: Run tests
        run: |
          python -m pytest tests/ -v --tb=short --cov=src --cov-report=xml

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.xml
          flags: unittests
          name: codecov-release
        continue-on-error: true

  build:
    name: Build Distribution
    needs: [detect-version, test]
    if: needs.detect-version.outputs.version-changed == 'true' && github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Create distribution package
        run: |
          VERSION="${{ needs.detect-version.outputs.version }}"
          DIST_DIR="dist"
          mkdir -p "$DIST_DIR"
          
          # Create source archive
          tar -czf "$DIST_DIR/mf07-language-${VERSION}.tar.gz" \
            --exclude='.git' \
            --exclude='.venv' \
            --exclude='__pycache__' \
            --exclude='*.pyc' \
            --exclude='dist' \
            --exclude='build' \
            --transform "s,^,mf07-language-${VERSION}/," \
            .
          
          # Create install script with version
          sed "s/VERSION=.*/VERSION=${VERSION}/" install.sh > "$DIST_DIR/install.sh"
          chmod +x "$DIST_DIR/install.sh"
          
          # Create version info
          echo "$VERSION" > "$DIST_DIR/VERSION"
          
          # Calculate checksums
          cd "$DIST_DIR"
          sha256sum * > SHA256SUMS
          cd ..

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-packages
          path: dist/
          retention-days: 7

  create-release:
    name: Create GitHub Release
    needs: [detect-version, build]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist-packages
          path: dist/

      - name: Generate changelog
        id: changelog
        run: |
          VERSION="${{ needs.detect-version.outputs.version }}"
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          if [ -n "$PREV_TAG" ]; then
            CHANGES=$(git log ${PREV_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
          else
            CHANGES=$(git log --pretty=format:"- %s (%h)" --no-merges | head -20)
          fi
          
          cat > release_notes.md << EOF
          ## What's Changed
          
          ${CHANGES}
          
          ## Installation
          
          \`\`\`bash
          # Quick install (recommended)
          curl -fsSL https://raw.githubusercontent.com/${{ github.repository }}/main/install.sh | bash
          
          # Or download specific version
          export MF_VERSION=${VERSION}
          curl -fsSL https://raw.githubusercontent.com/${{ github.repository }}/main/install.sh | bash
          \`\`\`
          
          **Full Changelog**: https://github.com/${{ github.repository }}/compare/${PREV_TAG}...v${VERSION}
          EOF

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.detect-version.outputs.version }}
          name: Release v${{ needs.detect-version.outputs.version }}
          body_path: release_notes.md
          files: dist/*
          draft: false
          prerelease: ${{ contains(needs.detect-version.outputs.version, '-') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-docs:
    name: Update Documentation
    needs: [detect-version, create-release]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update version in docs
        run: |
          VERSION="${{ needs.detect-version.outputs.version }}"
          find docs -type f -name "*.md" -exec sed -i "s/version: [0-9.]\+/version: $VERSION/g" {} +
          
          if git diff --quiet; then
            echo "No documentation changes needed"
          else
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add docs/
            git commit -m "docs: update version to $VERSION [skip ci]"
            git push
          fi

  deploy-pages:
    name: Deploy GitHub Pages
    needs: [detect-version, create-release]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Prepare public site
        run: |
          DEPLOY_DIR="public-deploy"
          VERSION="${{ needs.detect-version.outputs.version }}"
          mkdir -p "$DEPLOY_DIR"
          
          # Update version in public assets
          if [ -d "public" ]; then
            cp -r public/* "$DEPLOY_DIR/"
            sed -i "s/\${VERSION}/$VERSION/g" "$DEPLOY_DIR"/*.html 2>/dev/null || true
          fi
          
          touch "$DEPLOY_DIR/.nojekyll"
          echo "$VERSION" > "$DEPLOY_DIR/VERSION"

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public-deploy
          publish_branch: gh-pages
          keep_files: false

  notify:
    name: Notify Release
    needs: [detect-version, create-release]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Report status
        run: |
          VERSION="${{ needs.detect-version.outputs.version }}"
          if [ "${{ needs.create-release.result }}" = "success" ]; then
            echo "✓ Successfully released version $VERSION"
            echo "  GitHub: https://github.com/${{ github.repository }}/releases/tag/v$VERSION"
            echo "  Install: curl -fsSL https://raw.githubusercontent.com/${{ github.repository }}/main/install.sh | bash"
          else
            echo "✗ Release failed for version $VERSION"
            exit 1
          fi
