# Mini Sistema de Configura√ß√£o com JSON e .env
# Demonstra: leitura/escrita de arquivos, parsing JSON, vari√°veis de ambiente, valida√ß√£o

class ConfigManager {
    var configPath: string
    var envPath: string
    var config: dict
    var env: dict
    
    intent __init__(rootDir: string) {
        # Usar concatena√ß√£o de paths com f-string
        this.configPath = f"{rootDir}/config.json"
        this.envPath = f"{rootDir}/.env"
        this.config = {}
        this.env = {}
    }
    
    # Criar configura√ß√£o padr√£o
    async intent createDefaultConfig() {
        var defaultConfig = {
            "app": {
                "name": "MiniSystem",
                "version": "1.0.0",
                "debug": false
            },
            "database": {
                "host": "${DB_HOST}",
                "port": "${DB_PORT}",
                "name": "${DB_NAME}",
                "pool_size": 10
            },
            "api": {
                "base_url": "${API_URL}",
                "timeout": 30,
                "retry_count": 3
            },
            "features": {
                "enable_cache": true,
                "enable_logging": true,
                "max_upload_size": 10485760
            }
        }
        
        try {
            with open(this.configPath, "w") as f {
                var jsonString = JSON.stringify(defaultConfig, indent=2)
                await f.writeText(jsonString, null)
            }
            
            print(f"‚úì Config padr√£o criado: {this.configPath}")
        } catch (e: Exception) {
            print(f"ERRO ao criar config: {e}")
            print(f"ERRO tipo: {type(e)}")
            throw e
        }
        
        return defaultConfig
    }
    
    # Criar arquivo .env padr√£o
    async intent createDefaultEnv() {
        var envContent = "# Database Configuration\nDB_HOST=localhost\nDB_PORT=5432\nDB_NAME=minisystem_db\n\n# API Configuration\nAPI_URL=https://api.example.com\nAPI_KEY=your_secret_key_here\n\n# Environment\nENV=development\nLOG_LEVEL=debug\n"
        
        with open(this.envPath, "w") as f {
            await f.writeText(envContent, null)
        }
        
        print(f"‚úì Arquivo .env criado: {this.envPath}")
    }
    
    # Carregar vari√°veis do .env
    async intent loadEnv() {
        try {
            with open(this.envPath, "r") as f {
                var content = await f.readText("")
                
                # Parse simples: dividir em linhas e processar
                var normalized = content.replace("\r\n", "\n").replace("\r", "\n")
                var parts = normalized.split("\n")
                
                for (var line in parts) {
                    # Ignorar coment√°rios e linhas vazias
                    if (type(line) == "string" and line != "" and not line.startsWith("#")) {
                        if (line.contains("=")) {
                            var eqPos = line.indexOf("=")
                            if (eqPos > 0) {
                                var k = line.substring(0, eqPos)
                                var v = line.substring(eqPos + 1, len(line))
                                this.env[k] = v
                            }
                        }
                    }
                }
            }
            
            print(f"‚úì Vari√°veis de ambiente carregadas: {len(this.env.keys())} vars")
            return true
        } catch (e: Exception) {
            print(f"‚úó Erro ao carregar .env: {e}")
            return false
        }
    }
    
    # Carregar e interpolar configura√ß√£o JSON
    async intent loadConfig() {
        try {
            with open(this.configPath, "r") as f {
                var content = await f.readText("")
                this.config = JSON.parse(content)
            }
            
            # Interpolar vari√°veis de ambiente
            this.config = this._interpolateEnvVars(this.config)
            
            print(f"‚úì Configura√ß√£o carregada e interpolada")
            return this.config
        } catch (e: Exception) {
            print(f"‚úó Erro ao carregar config: {e}")
            return null
        }
    }
    
    # Interpolar ${VAR} com valores do .env
    intent _interpolateEnvVars(obj) {
        if (type(obj) == "string") {
            # Substituir ${VAR} por valor do env
            var result = obj
            for (var key in this.env.keys()) {
                var placeholder = f"${{{key}}}"
                if (result.contains(placeholder)) {
                    result = result.replace(placeholder, this.env[key])
                }
            }
            return result
        } else if (type(obj) == "dict") {
            var newDict = {}
            for (var key in obj.keys()) {
                newDict[key] = this._interpolateEnvVars(obj[key])
            }
            return newDict
        } else if (type(obj) == "list") {
            var newList = []
            for (var item in obj) {
                newList.append(this._interpolateEnvVars(item))
            }
            return newList
        } else {
            return obj
        }
    }
    
    # Obter valor de configura√ß√£o por caminho (ex: "database.host")
    intent get(path: string) {
        var parts = path.split(".")
        var current = this.config
        
        for (var part in parts) {
            if (type(current) == "dict" and current.hasKey(part)) {
                current = current[part]
            } else {
                return null
            }
        }
        
        return current
    }
    
    # Atualizar configura√ß√£o e salvar
    async intent set(path: string, value) {
        var parts = path.split(".")
        var current = this.config
        
        # Navegar at√© o pen√∫ltimo n√≠vel
        for (var i = 0; i < len(parts) - 1; i = i + 1) {
            var part = parts[i]
            if (not current.hasKey(part)) {
                current[part] = {}
            }
            current = current[part]
        }
        
        # Definir o valor
        current[parts[len(parts) - 1]] = value
        
        # Salvar no arquivo
        with open(this.configPath, "w") as f {
            var jsonString = JSON.stringify(this.config, indent=2)
            await f.writeText(jsonString, null)
        }
        
        print(f"‚úì Configura√ß√£o atualizada: {path} = {value}")
    }
    
    # Validar configura√ß√£o
    intent validate() {
        var errors = []
        
        # Verificar se config foi carregado
        if (this.config == null or type(this.config) != "dict") {
            errors.append("Configura√ß√£o n√£o foi carregada")
            return {
                "valid": false,
                "errors": errors
            }
        }
        
        # Validar campos obrigat√≥rios
        if (not this.config.hasKey("app")) {
            errors.append("Campo 'app' √© obrigat√≥rio")
        }
        
        if (not this.config.hasKey("database")) {
            errors.append("Campo 'database' √© obrigat√≥rio")
        } else {
            var db = this.config["database"]
            if (not db.hasKey("host") or db["host"] == "") {
                errors.append("database.host n√£o pode ser vazio")
            }
            if (not db.hasKey("port")) {
                errors.append("database.port √© obrigat√≥rio")
            }
        }
        
        # Validar tipos
        if (this.config.hasKey("features")) {
            var features = this.config["features"]
            if (features.hasKey("max_upload_size")) {
                if (type(features["max_upload_size"]) != "int") {
                    errors.append("features.max_upload_size deve ser um n√∫mero")
                }
            }
        }
        
        return {
            "valid": len(errors) == 0,
            "errors": errors
        }
    }
    
    # Exibir configura√ß√£o atual
    intent display() {
        print("\n=== CONFIGURA√á√ÉO ATUAL ===")
        print(JSON.stringify(this.config, indent=2))
        print("\n=== VARI√ÅVEIS DE AMBIENTE ===")
        for (var key in this.env.keys()) {
            var value = this.env[key]
            # Mascarar valores sens√≠veis
            if (key.contains("KEY") or key.contains("SECRET") or key.contains("PASSWORD")) {
                value = "***HIDDEN***"
            }
            print(f"{key}: {value}")
        }
    }
}

# Sistema principal
async intent main() {
    print("üöÄ Mini Sistema de Configura√ß√£o\n")
    
    # Setup
    var root = Path.join(Path.cwd(), "tests", "config_system")
    var workdir = new Directory(root)
    if (not workdir.exists()) {
        workdir.ensure()
        print(f"‚úì Diret√≥rio criado: {root}\n")
    }
    
    var configMgr = new ConfigManager(root)
    
    # 1. Criar arquivos de configura√ß√£o
    print("üìù Etapa 1: Criando arquivos de configura√ß√£o...")
    await configMgr.createDefaultConfig()
    await configMgr.createDefaultEnv()
    
    # 2. Carregar vari√°veis de ambiente
    print("\nüìù Etapa 2: Carregando vari√°veis de ambiente...")
    await configMgr.loadEnv()
    
    # 3. Carregar e interpolar configura√ß√£o
    print("\nüìù Etapa 3: Carregando configura√ß√£o...")
    var config = await configMgr.loadConfig()
    
    # 4. Validar configura√ß√£o
    print("\nüìù Etapa 4: Validando configura√ß√£o...")
    var validation = configMgr.validate()
    if (validation["valid"]) {
        print("‚úì Configura√ß√£o v√°lida!")
    } else {
        print("‚úó Erros encontrados:")
        for (var error in validation["errors"]) {
            print(f"  - {error}")
        }
    }
    
    # 5. Acessar valores espec√≠ficos
    print("\nüìù Etapa 5: Acessando valores...")
    print(f"App Name: {configMgr.get('app.name')}")
    print(f"Database Host: {configMgr.get('database.host')}")
    print(f"Database Port: {configMgr.get('database.port')}")
    print(f"API URL: {configMgr.get('api.base_url')}")
    print(f"Cache Enabled: {configMgr.get('features.enable_cache')}")
    
    # 6. Atualizar configura√ß√£o
    print("\nüìù Etapa 6: Atualizando configura√ß√£o...")
    await configMgr.set("app.debug", true)
    await configMgr.set("features.max_upload_size", 20971520)
    
    # 7. Recarregar e exibir
    print("\nüìù Etapa 7: Recarregando configura√ß√£o atualizada...")
    await configMgr.loadConfig()
    configMgr.display()
    
    print("\n‚úÖ Sistema de configura√ß√£o conclu√≠do!")
}

print("=" * 60)
await main()
print("=" * 60)
